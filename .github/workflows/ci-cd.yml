name: CI/CD Pipeline with Playwright Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Backend Tests and Build
  backend-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: sheikh_ai_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx

    - name: Run backend tests
      run: |
        cd backend
        # Run pytest with coverage
        pytest --cov=app --cov-report=xml --cov-report=term-missing
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/sheikh_ai_test
        GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: Upload backend coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage

  # Frontend Tests with Playwright
  frontend-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Install Playwright browsers
      run: |
        cd frontend
        npx playwright install --with-deps

    - name: Start backend server
      run: |
        cd backend
        python -m uvicorn app.interfaces.api.main:app --host 0.0.0.0 --port 8000 &
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/sheikh_ai_test
        GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: Wait for backend
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8000/api/v1/health; do sleep 1; done'

    - name: Start frontend server
      run: |
        cd frontend
        npm run dev &
      env:
        VITE_API_BASE_URL: http://localhost:8000/api/v1

    - name: Wait for frontend
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 1; done'

    - name: Run Playwright tests
      run: |
        cd frontend
        npx playwright test
      env:
        CI: true

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: frontend/test-results/
        retention-days: 30

    - name: Upload to Azure Pipelines
      uses: Azure/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: frontend/test-results/

  # Security and Quality Checks
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Performance Tests
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install load testing tools
      run: |
        pip install locust

    - name: Start services
      run: |
        cd backend && python -m uvicorn app.interfaces.api.main:app --host 0.0.0.0 --port 8000 &
        cd frontend && npm run dev &
      env:
        GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: Wait for services
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8000/api/v1/health; do sleep 1; done'
        timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 1; done'

    - name: Run basic load test
      run: |
        python -c "
        import requests
        import time
        import concurrent.futures
        
        def make_request():
            try:
                response = requests.get('http://localhost:8000/api/v1/health', timeout=5)
                return response.status_code == 200
            except:
                return False
        
        # Test 100 concurrent requests
        start_time = time.time()
        with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
            futures = [executor.submit(make_request) for _ in range(100)]
            results = [future.result() for future in concurrent.futures.as_completed(futures)]
        
        success_rate = sum(results) / len(results) * 100
        duration = time.time() - start_time
        
        print(f'Success Rate: {success_rate:.2f}%')
        print(f'Duration: {duration:.2f}s')
        
        if success_rate < 95:
            exit(1)
        "

  # Build and Deploy (only on main branch)
  deploy:
    needs: [backend-test, frontend-test, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker images
      run: |
        docker build -t sheikh-ai-backend ./backend
        docker build -t sheikh-ai-frontend ./frontend

    - name: Save Docker images
      run: |
        docker save sheikh-ai-backend | gzip > backend.tar.gz
        docker save sheikh-ai-frontend | gzip > frontend.tar.gz

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: docker-images
        path: |
          backend.tar.gz
          frontend.tar.gz

  # Notification on failure
  notify-failure:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, security-scan, performance-test]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Notify on failure
      run: |
        echo "CI/CD Pipeline failed for commit ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Author: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        echo "Please check the workflow logs for details."
      # Add your notification logic here (Slack, Discord, Email, etc.)

  # Success notification
  notify-success:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Notify on success
      run: |
        echo "CI/CD Pipeline succeeded for commit ${{ github.sha }}"
        echo "Deployment artifacts have been created."
      # Add your notification logic here