# Supervisor configuration for Sheikh Sandbox Environment
# Manages component processes in the isolated execution environment

[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
pidfile=/app/logs/supervisord.pid

# Environment variables for all processes
environment=PYTHONPATH="/app/backend",PYTHONUNBUFFERED=1,PYTHONDONTWRITEBYTECODE=1

# FastAPI Backend Service
[program:sheikh-backend]
command=uvicorn backend.app.interfaces.api.main:app --host 0.0.0.0 --port 8080 --reload
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/backend.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=10
priority=1

# VNC Server
[program:vnc-server]
command=x11vnc -display :1 -forever -shared -rfbport 5900 -rfbportv6 5900 -wait 10
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/vnc.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
priority=10

# Xvfb (Virtual Framebuffer)
[program:xvfb]
command=Xvfb :1 -screen 0 1280x720x24 -ac +extension GLX +render -noreset
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/xvfb.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
priority=9

# Window Manager (Fluxbox)
[program:window-manager]
command=fluxbox
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/window-manager.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
priority=11

# Chrome Browser (for automation)
[program:chrome]
command=google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 --disable-web-security --user-data-dir=/app/browser/user_data --no-sandbox --disable-dev-shm-usage
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/chrome.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=5
priority=20

# VNC WebSocket Server (if using websockify)
[program:vnc-websockify]
command=websockify --web /app/vnc 0.0.0.0:5901
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/websockify.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
priority=12

# Process Monitor
[program:process-monitor]
command=python3 -c "import time; import sys; time.sleep(5); print('Sheikh Sandbox Environment Started Successfully')"
directory=/app
user=root
autostart=true
autorestart=false
redirect_stderr=true
stdout_logfile=/app/logs/startup.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
priority=100

# Shell Session Manager
[program:shell-session]
command=python3 -c "
import os
import subprocess
import signal
import time

# Create a shell session manager
def signal_handler(signum, frame):
    print('Shell session manager received signal:', signum)
    sys.exit(0)

signal.signal(signal.SIGTERM, signal_handler)
signal.signal(signal.SIGINT, signal_handler)

# Monitor shell sessions
while True:
    time.sleep(60)
    # Clean up old shell processes if needed
    try:
        result = subprocess.run(['ps', 'aux'], capture_output=True, text=True)
        shell_processes = [line for line in result.stdout.split('\\n') if 'bash' in line or 'sh' in line]
        print(f'Active shell processes: {len(shell_processes)}')
    except Exception as e:
        print(f'Error monitoring shell processes: {e}')
"
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/shell-monitor.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
priority=30